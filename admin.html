<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Panel - JNK Express</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #f4f4f4; }
    .controls { margin-bottom: 20px; }
    .controls input, .controls select, .controls button { margin-right: 10px; }
    #pagination { margin-top: 20px; }
  </style>
</head>
<body>

<h1>JNK Express Admin Panel</h1>

<div class="controls">
  <input type="text" id="parcelName" placeholder="Parcel Name">
  <input type="text" id="customerName" placeholder="Customer Name">
  <input type="text" id="barangay" placeholder="Barangay">
  <input type="number" id="price" placeholder="Price">
  <input type="text" id="trackingNumber" placeholder="Tracking Number">
  <select id="statusSelect">
    <option>Package Received</option>
    <option>In Transit</option>
    <option>Out for Delivery</option>
    <option>Delivered</option>
  </select>
  <button id="printReceipt">Print Receipt</button>
</div>

<div>
  <div id="reader" style="width:300px;"></div>
</div>

<hr>

<!-- CSV Export by Date -->
<h3>Export to CSV</h3>
<input type="date" id="exportFromDate">
<input type="date" id="exportToDate">
<button id="exportCSV">Export CSV</button>

<!-- Bulk Update FROM–TO -->
<h3>Bulk Update Status</h3>
<label>From Date:</label>
<input type="date" id="bulkFromDate">
<input type="time" id="bulkFromTime">
<label>To Date:</label>
<input type="date" id="bulkToDate">
<input type="time" id="bulkToTime">
<select id="bulkStatus">
  <option>Package Received</option>
  <option>In Transit</option>
  <option>Out for Delivery</option>
  <option>Delivered</option>
</select>
<button id="applyBulkUpdate">Apply Bulk Update</button>

<hr>

<input type="text" id="searchInput" placeholder="Search...">
<table id="parcelTable">
  <thead>
    <tr>
      <th>Tracking Number</th>
      <th>Parcel Name</th>
      <th>Customer Name</th>
      <th>Barangay</th>
      <th>Price</th>
      <th>Status</th>
      <th>Date</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div id="pagination"></div>

<script>
  const firebaseConfig = {
    // your Firebase config here
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Auto-fill Barangay from customer name
  document.getElementById('customerName').addEventListener('input', async function() {
    const name = this.value.trim();
    if (name.length > 0) {
      const docRef = db.collection('customers').doc(name);
      const docSnap = await docRef.get();
      if (docSnap.exists) {
        document.getElementById('barangay').value = docSnap.data().barangay || '';
      }
    }
  });

  // Save & print receipt
  document.getElementById('printReceipt').addEventListener('click', async function() {
    const parcelName = document.getElementById('parcelName').value.trim();
    const customerName = document.getElementById('customerName').value.trim();
    const barangay = document.getElementById('barangay').value.trim();
    const price = parseFloat(document.getElementById('price').value);
    const trackingNumber = document.getElementById('trackingNumber').value.trim();
    const status = document.getElementById('statusSelect').value;

    if (!parcelName || !customerName || !barangay || !price || !trackingNumber) {
      alert('Please fill in all fields');
      return;
    }

    // Save to customers collection
    await db.collection('customers').doc(customerName).set({ barangay });

    // Save to tracking collection
    const now = new Date();
    await db.collection('tracking').doc(trackingNumber).set({
      trackingNumber,
      parcelName,
      customerName,
      barangay,
      price,
      status,
      date: now.toISOString(),
      statusHistory: firebase.firestore.FieldValue.arrayUnion({ status, date: now.toISOString() })
    });

    // Print receipt
    const printWindow = window.open('', '', 'width=300,height=400');
    printWindow.document.write(`
      <html><body style="font-family: Arial; font-size: 12px; text-align:center;">
        <img src="https://raw.githubusercontent.com/yourgithub/logo.png" width="50"><br>
        <strong>JNK Express Padala</strong><br>
        Parcel: ${parcelName}<br>
        Barangay: ${barangay}<br>
        Price: ₱${price}<br>
        Tracking #: ${trackingNumber}<br>
        <em>Thank you for your support</em>
      </body></html>
    `);
    printWindow.document.close();
    printWindow.print();
  });

  // Barcode scanner
  function onScanSuccess(decodedText) {
    document.getElementById('trackingNumber').value = decodedText;
    document.getElementById('printReceipt').click();
  }
  const html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
  html5QrcodeScanner.render(onScanSuccess);

  // Bulk update FROM–TO
  document.getElementById('applyBulkUpdate').addEventListener('click', async function() {
    const fromDate = document.getElementById('bulkFromDate').value;
    const fromTime = document.getElementById('bulkFromTime').value || '00:00';
    const toDate = document.getElementById('bulkToDate').value;
    const toTime = document.getElementById('bulkToTime').value || '23:59';
    const status = document.getElementById('bulkStatus').value;

    if (!fromDate || !toDate) {
      alert('Please select both FROM and TO dates');
      return;
    }

    const start = new Date(`${fromDate}T${fromTime}`);
    const end = new Date(`${toDate}T${toTime}`);

    const snapshot = await db.collection('tracking').get();
    snapshot.forEach(async doc => {
      const data = doc.data();
      const itemDate = new Date(data.date);
      if (itemDate >= start && itemDate <= end) {
        await db.collection('tracking').doc(doc.id).update({
          status,
          statusHistory: firebase.firestore.FieldValue.arrayUnion({ status, date: new Date().toISOString() })
        });
      }
    });

    alert('Bulk update applied.');
  });

  // CSV Export
  document.getElementById('exportCSV').addEventListener('click', async function() {
    const fromDate = document.getElementById('exportFromDate').value;
    const toDate = document.getElementById('exportToDate').value;
    if (!fromDate || !toDate) {
      alert('Please select date range');
      return;
    }
    const start = new Date(fromDate);
    const end = new Date(toDate);
    let csvContent = "data:text/csv;charset=utf-8,Tracking Number,Parcel Name,Customer Name,Barangay,Price,Status,Date\n";
    const snapshot = await db.collection('tracking').get();
    snapshot.forEach(doc => {
      const d = doc.data();
      const itemDate = new Date(d.date);
      if (itemDate >= start && itemDate <= end) {
        csvContent += `${d.trackingNumber},${d.parcelName},${d.customerName},${d.barangay},${d.price},${d.status},${d.date}\n`;
      }
    });
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement('a');
    link.setAttribute('href', encodedUri);
    link.setAttribute('download', `export_${fromDate}_to_${toDate}.csv`);
    document.body.appendChild(link);
    link.click();
  });

</script>

</body>
</html>
