<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Panel - JNK Express</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: sans-serif; background: #fff3f3; padding: 20px; max-width: 900px; margin: auto; }
    h2, h3 { color: #D7282F; margin-bottom: 8px; }
    input, select, button {
      padding: 10px; margin-top: 5px; font-size: 1em;
      border-radius: 6px; border: 1px solid #ccc;
    }
    button { background-color: #D7282F; color: white; border: none; cursor: pointer; }
    button:hover { opacity: 0.9; }
    .item {
      background: #fff; padding: 10px; margin: 10px 0;
      border-left: 5px solid #D7282F; border-radius: 4px;
      display: flex; justify-content: space-between; align-items: flex-start;
    }
    .item-content { flex: 1; }
    .export-btn { background: #2a9d8f; color: #fff; margin-bottom: 5px; }
    .delete-btn { background: #888; color: white; }
    .top-bar { display: flex; gap: 10px; flex-wrap: wrap; }
    .pagination { display: flex; justify-content: center; gap: 10px; margin-top: 20px; }
    #receiptArea { display: none; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    table th, table td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    table th { background: #eee; }
  </style>
</head>
<body>
  <h2>JNK Admin Panel</h2>
  <input type="text" id="username" placeholder="Username" />
  <input type="password" id="password" placeholder="Password" />
  <button onclick="login()">Login</button>
  <p id="loginMessage" style="color:red;"></p>

  <div id="adminSection" style="display:none;">
    <button onclick="logout()">Logout</button>

    <h3>Add / Update Tracking</h3>
    <input type="text" id="trackNumber" placeholder="Tracking Number" />
    <input type="text" id="parcelName" placeholder="Parcel Name" />
    <input type="text" id="barangay" placeholder="Barangay" />
    <input type="number" id="price" placeholder="Price (PHP)" />
    <select id="trackStatus">
      <option value="">Select Status</option>
      <option>Package Received</option>
      <option>In Transit</option>
      <option>Arrived</option>
      <option>For Pick-up</option>
    </select>
    <input type="text" id="trackLocation" placeholder="Location" />
    <input type="date" id="estimatedDate" />
    <button onclick="saveTracking()">Save</button>
    <button onclick="printAndSave()">üñ®Ô∏è Print & Save</button>

    <button onclick="startScanner()">üì∑ Scan</button>
    <div id="scannerContainer" style="display:none">
      <div id="scanner" style="width:100%"></div>
      <button onclick="stopScanner()">‚ùå Cancel</button>
    </div>

    <h3>Search</h3>
    <div class="top-bar">
      <input type="text" id="searchInput" placeholder="Search tracking number..." />
      <button onclick="renderEntries()">Search</button>
    </div>

    <h3>Export to Excel by Date Range</h3>
    <div class="top-bar">
      <input type="date" id="exportFrom" />
      <input type="date" id="exportTo" />
      <button onclick="exportExcelByDateRange()">Export</button>
    </div>

    <h3>Bulk Update (From ‚Üí To)</h3>
    <div class="top-bar">
      <input type="date" id="bulkFromDate" />
      <input type="time" id="bulkFromTime" />
      <input type="date" id="bulkToDate" />
      <input type="time" id="bulkToTime" />
      <select id="bulkStatus">
        <option value="">Update Status to...</option>
        <option>Package Received</option>
        <option>In Transit</option>
        <option>Arrived</option>
        <option>For Pick-up</option>
      </select>
      <input type="text" id="bulkLocation" placeholder="Optional New Location" />
      <button onclick="bulkUpdateByTimeRange()">Apply</button>
    </div>

    <h3>Backfill Missing Data</h3>
    <button onclick="loadBackfill()">Load Missing Entries</button>
    <div id="backfillList"></div>

    <h3>All Tracking Entries</h3>
    <div id="entries"></div>
    <div class="pagination">
      <button onclick="prevPage()">Previous</button>
      <button onclick="nextPage()">Next</button>
    </div>
  </div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAnrNfuTSRAKUS2tAU4AUUrauw_QzszCjY",
  authDomain: "jnk-ordertracker.firebaseapp.com",
  projectId: "jnk-ordertracker",
  storageBucket: "jnk-ordertracker.appspot.com",
  messagingSenderId: "421193030070",
  appId: "1:421193030070:web:078e39980237bc41f64917"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const USERNAME = "JNK";
const PASSWORD = "11223344$";
let allEntries = [];
let currentPage = 1;
const pageSize = 10;

function login() {
  if (document.getElementById("username").value === USERNAME && document.getElementById("password").value === PASSWORD) {
    document.getElementById("adminSection").style.display = "block";
    document.getElementById("username").style.display = "none";
    document.getElementById("password").style.display = "none";
    document.querySelector("button[onclick='login()']").style.display = "none";
    loadAllEntries();
  } else {
    document.getElementById("loginMessage").innerText = "Invalid login.";
  }
}
function logout() { location.reload(); }

function startScanner() {
  document.getElementById("scannerContainer").style.display = "block";
  const scanner = new Html5Qrcode("scanner");
  scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 },
    (decodedText) => { document.getElementById("trackNumber").value = decodedText.trim(); stopScanner(); printAndSave(); });
}
function stopScanner() { document.getElementById("scannerContainer").style.display = "none"; }

async function saveCore({ print = false } = {}) {
  const number = document.getElementById("trackNumber").value.trim().toUpperCase();
  const name = document.getElementById("parcelName").value.trim();
  const barangay = document.getElementById("barangay").value.trim();
  const price = document.getElementById("price").value.trim();
  const status = document.getElementById("trackStatus").value;
  const location = document.getElementById("trackLocation").value.trim();
  const estimatedDate = document.getElementById("estimatedDate").value;
  const now = firebase.firestore.Timestamp.now();

  if (!number || !name || !barangay || !price || !status) { alert("Complete all fields"); return false; }

  const docRef = db.collection("tracking").doc(number);
  const docSnap = await docRef.get();
  let statusHistory = docSnap.exists ? (docSnap.data().statusHistory || []) : [];
  statusHistory.push({ status, timestamp: now });

  await docRef.set({ parcelName: name, barangay, price, location, estimatedDate, statusHistory, timestamp: now });

  if (print) { /* printing code here */ }

  ["trackNumber","parcelName","barangay","price","trackStatus","trackLocation","estimatedDate"].forEach(id => document.getElementById(id).value = "");
  loadAllEntries();
  return true;
}
function saveTracking() { return saveCore({ print: false }); }
function printAndSave() { return saveCore({ print: true }); }

function loadAllEntries() {
  db.collection("tracking").orderBy("timestamp", "desc").onSnapshot(snapshot => {
    allEntries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), timestamp: doc.data().timestamp?.toDate() || null }));
    renderEntries();
  });
}

function renderEntries() {
  const search = document.getElementById("searchInput").value.toUpperCase();
  const entriesDiv = document.getElementById("entries");
  entriesDiv.innerHTML = "";
  const filtered = allEntries.filter(e => e.id.includes(search));
  const start = (currentPage - 1) * pageSize;
  filtered.slice(start, start + pageSize).forEach(entry => {
    const timeline = (entry.statusHistory || []).map(h => `[${h.timestamp?.toDate().toLocaleString() || 'N/A'}] ${h.status}`).join("<br>");
    entriesDiv.innerHTML += 
      `<div class="item">
        <div class="item-content">
          <strong>${entry.id}</strong><br>
          Parcel: ${entry.parcelName || ''}<br>
          Barangay: ${entry.barangay || ''}<br>
          Price: ‚Ç±${entry.price || ''}<br>
          Location: ${entry.location || ''}<br>
          Estimated Delivery: ${entry.estimatedDate || ''}<br>
          Encoded: ${entry.timestamp ? entry.timestamp.toLocaleString() : ''}<br>
          Timeline:<div>${timeline}</div>
        </div>
        <div>
          <button class="export-btn" onclick="exportSingleToExcel('${entry.id}')">Export</button>
          <button class="delete-btn" onclick="deleteEntry('${entry.id}')">Delete</button>
        </div>
      </div>`;
  });
}

function nextPage() { if (currentPage < Math.ceil(allEntries.length / pageSize)) currentPage++; renderEntries(); }
function prevPage() { if (currentPage > 1) currentPage--; renderEntries(); }

function exportExcelByDateRange() {
  const from = new Date(document.getElementById("exportFrom").value);
  const to = new Date(document.getElementById("exportTo").value);
  to.setHours(23, 59, 59, 999);
  const filtered = allEntries.filter(e => e.timestamp && e.timestamp >= from && e.timestamp <= to);
  if (!filtered.length) return alert("No entries found in that date range");
  const data = filtered.map(e => ({
    TrackingNumber: e.id,
    ParcelName: e.parcelName || '',
    Barangay: e.barangay || '',
    Price: e.price || ''
  }));
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Tracking Data");
  XLSX.writeFile(wb, `tracking_export_${filtered.length}_items.xlsx`);
}

function exportSingleToExcel(id) {
  const e = allEntries.find(x => x.id === id);
  if (!e) return alert("Entry not found");
  const data = [{
    TrackingNumber: e.id,
    ParcelName: e.parcelName || '',
    Barangay: e.barangay || '',
    Price: e.price || ''
  }];
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Tracking Entry");
  XLSX.writeFile(wb, `tracking_${id}.xlsx`);
}

async function deleteEntry(id) {
  if (prompt("Password:") !== PASSWORD) return alert("Wrong password");
  await db.collection("tracking").doc(id).delete();
  loadAllEntries();
}

async function bulkUpdateByTimeRange() {
  const fromDateTime = new Date(`${document.getElementById("bulkFromDate").value}T${document.getElementById("bulkFromTime").value || "00:00"}`);
  const toDateTime = new Date(`${document.getElementById("bulkToDate").value}T${document.getElementById("bulkToTime").value || "23:59"}`);
  const status = document.getElementById("bulkStatus").value;
  const location = document.getElementById("bulkLocation").value.trim();
  if (!status) return alert("Select status");
  if (prompt("Password:") !== PASSWORD) return alert("Wrong password");
  const fromTs = firebase.firestore.Timestamp.fromDate(fromDateTime);
  const toTs = firebase.firestore.Timestamp.fromDate(toDateTime);
  const snap = await db.collection("tracking").where("timestamp", ">=", fromTs).where("timestamp", "<=", toTs).get();
  const batch = db.batch();
  snap.docs.forEach(doc => {
    const data = doc.data();
    const history = data.statusHistory || [];
    history.push({ status, timestamp: firebase.firestore.Timestamp.now() });
    batch.update(doc.ref, { location: location || data.location, statusHistory: history });
  });
  await batch.commit();
  loadAllEntries();
}

function loadBackfill() {
  const missing = allEntries.filter(e => !e.parcelName || !e.barangay || !e.price);
  if (!missing.length) { alert("No missing data"); return; }
  const container = document.getElementById("backfillList");
  container.innerHTML = `<table><tr><th>Tracking #</th><th>Parcel Name</th><th>Barangay</th><th>Price</th><th>Save</th></tr>` +
    missing.map(e => `<tr>
      <td>${e.id}</td>
      <td><input id="bf-name-${e.id}" value="${e.parcelName || ''}"></td>
      <td><input id="bf-barangay-${e.id}" value="${e.barangay || ''}"></td>
      <td><input type="number" id="bf-price-${e.id}" value="${e.price || ''}"></td>
      <td><button onclick="saveBackfill('${e.id}')">Save</button></td>
    </tr>`).join("") + "</table>";
}

async function saveBackfill(id) {
  const name = document.getElementById(`bf-name-${id}`).value.trim();
  const barangay = document.getElementById(`bf-barangay-${id}`).value.trim();
  const price = document.getElementById(`bf-price-${id}`).value.trim();
  await db.collection("tracking").doc(id).update({ parcelName: name, barangay, price });
  alert(`Updated ${id}`);
  loadAllEntries();
}
</script>
</body>
</html>
