<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Panel - JNK Express</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <style>
    body { font-family: sans-serif; background: #fff3f3; padding: 20px; max-width: 800px; margin: auto; }
    h2 { color: #D7282F; }
    input, select, button {
      width: 100%; padding: 12px; margin-top: 10px;
      font-size: 1em; border-radius: 6px; border: 1px solid #ccc;
    }
    button { background-color: #D7282F; color: white; border: none; margin-bottom: 20px; cursor: pointer; }
    .item {
      background: #fff; padding: 10px; margin: 10px 0;
      border-left: 5px solid #D7282F; border-radius: 4px;
      display: flex; justify-content: space-between; align-items: flex-start;
    }
    .item-content { width: 100%; }
    .delete-btn {
      background: #aaa; color: white; border: none;
      padding: 6px 10px; border-radius: 4px; cursor: pointer; margin-left: 10px;
    }
    .pagination { display: flex; justify-content: center; gap: 10px; margin-top: 20px; }
    .timeline { margin-top: 5px; padding-left: 10px; font-size: 0.95em; color: #333; }
    .top-bar { display: flex; gap: 10px; flex-wrap: wrap; }
    #receiptArea { display: none; }
  </style>
</head>
<body>
  <h2>JNK Admin Panel</h2>
  <input type="text" id="username" placeholder="Username" />
  <input type="password" id="password" placeholder="Password" />
  <button onclick="login()">Login</button>
  <p id="loginMessage" style="color:red;"></p>

  <div id="adminSection" style="display:none;">
    <input type="text" id="trackNumber" placeholder="Tracking Number" />
    <input type="text" id="parcelName" placeholder="Parcel Name" />
    <input type="text" id="barangay" placeholder="Barangay" />
    <input type="number" id="price" placeholder="Price (PHP)" />
    <select id="trackStatus">
      <option value="">Select Status</option>
      <option>Package Received</option>
      <option>In Transit</option>
      <option>Arrived</option>
      <option>For Pick-up</option>
    </select>
    <input type="text" id="trackLocation" placeholder="Location (e.g., Manila Hub)" />
    <input type="date" id="estimatedDate" />
    <button onclick="saveTracking()">Add / Update</button>
    <button onclick="printAndSave()">üñ®Ô∏è Print Receipt</button>

    <button onclick="startScanner()">üì∑ Scan</button>
    <div id="scannerContainer" style="display:none">
      <div id="scanner" style="width:100%"></div>
      <button onclick="stopScanner()">‚ùå Cancel</button>
    </div>

    <div class="top-bar">
      <input type="text" id="searchInput" placeholder="Search tracking number..." />
      <button onclick="renderEntries()">üîç Search</button>
    </div>

    <div class="top-bar">
      <input type="date" id="exportFrom" />
      <input type="date" id="exportTo" />
      <button onclick="exportCSVByDateRange()">Export CSV by Date</button>
    </div>

    <!-- ORIGINAL single-day bulk inputs (kept as requested) -->
    <div class="top-bar">
      <input type="date" id="bulkDate" />
      <input type="time" id="startTime" />
      <input type="time" id="endTime" />
      <select id="bulkStatus">
        <option value="">Update Status to...</option>
        <option>Package Received</option>
        <option>In Transit</option>
        <option>Arrived</option>
        <option>For Pick-up</option>
      </select>
      <input type="text" id="bulkLocation" placeholder="Optional New Location" />
      <button onclick="bulkUpdateByTimeRange()">Apply Bulk Update</button>
    </div>

    <!-- NEW FROM‚ÄìTO bulk inputs -->
    <h3>Bulk Update (From ‚Üí To)</h3>
    <div class="top-bar">
      <div style="flex:1 1 180px">
        <label>From Date</label>
        <input type="date" id="bulkFromDate" />
      </div>
      <div style="flex:1 1 160px">
        <label>From Time</label>
        <input type="time" id="bulkFromTime" />
      </div>
      <div style="flex:1 1 180px">
        <label>To Date</label>
        <input type="date" id="bulkToDate" />
      </div>
      <div style="flex:1 1 160px">
        <label>To Time</label>
        <input type="time" id="bulkToTime" />
      </div>
      <div style="flex:1 1 240px">
        <label>New Status</label>
        <select id="bulkStatusNew">
          <option value="">Update Status to...</option>
          <option>Package Received</option>
          <option>In Transit</option>
          <option>Arrived</option>
          <option>For Pick-up</option>
        </select>
      </div>
      <div style="flex:1 1 260px">
        <label>Optional New Location</label>
        <input type="text" id="bulkLocationNew" placeholder="Optional New Location" />
      </div>
      <div style="flex:1 1 200px; align-self:flex-end">
        <button onclick="bulkUpdateByFromTo()">Apply FROM‚ÄìTO Bulk Update</button>
      </div>
    </div>

    <h3>All Tracking Entries</h3>
    <div id="entries"></div>
    <div class="pagination">
      <button onclick="prevPage()">Previous</button>
      <button onclick="nextPage()">Next</button>
    </div>
  </div>

  <div id="receiptArea">
    <div id="receiptContent" style="font-family:monospace; font-size:10pt;"></div>
  </div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAnrNfuTSRAKUS2tAU4AUUrauw_QzszCjY",
  authDomain: "jnk-ordertracker.firebaseapp.com",
  projectId: "jnk-ordertracker",
  storageBucket: "jnk-ordertracker.appspot.com",
  messagingSenderId: "421193030070",
  appId: "1:421193030070:web:078e39980237bc41f64917"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const USERNAME = "JNK";
const PASSWORD = "11223344$";
let allEntries = [];
let currentPage = 1;
const pageSize = 10;

function login() {
  const user = document.getElementById("username").value;
  const pass = document.getElementById("password").value;
  if (user === USERNAME && pass === PASSWORD) {
    document.getElementById("adminSection").style.display = "block";
    document.getElementById("loginMessage").innerText = "";
    loadAllEntries();
  } else {
    document.getElementById("loginMessage").innerText = "Invalid login.";
  }
}

let scanner;
function startScanner() {
  document.getElementById("scannerContainer").style.display = "block";
  scanner = new Html5Qrcode("scanner");
  scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 },
    (decodedText) => {
      document.getElementById("trackNumber").value = decodedText.trim();
      stopScanner();
      printAndSave();
    },
    () => {}
  );
}
function stopScanner() {
  document.getElementById("scannerContainer").style.display = "none";
  if (scanner) scanner.stop().then(() => scanner.clear()).catch(() => {});
}

async function printAndSave() {
  const number = document.getElementById("trackNumber").value.trim().toUpperCase();
  const name = document.getElementById("parcelName").value.trim();
  const barangay = document.getElementById("barangay").value.trim();
  const price = document.getElementById("price").value.trim();
  const status = document.getElementById("trackStatus").value;
  const location = document.getElementById("trackLocation").value.trim();
  const estimatedDate = document.getElementById("estimatedDate").value;
  const now = firebase.firestore.Timestamp.now();

  if (!number || !name || !barangay || !price || !status) return alert("Complete all fields");

  // Save to Firestore
  const docRef = db.collection("tracking").doc(number);
  const docSnap = await docRef.get();
  let statusHistory = docSnap.exists ? docSnap.data().statusHistory || [] : [];
  statusHistory.push({ status, timestamp: now });

  await docRef.set({
    location,
    estimatedDate,
    statusHistory,
    timestamp: now
  });

  // Receipt content with logo and layout
  const logoUrl = "logo.jpg"; // Replace with your actual logo if needed
  const content = `
    <div style="width: 48mm; height: 78mm; padding: 1mm; font-size: 10pt; font-family: monospace; text-align: center;">
      <img src="${logoUrl}" style="width: 30mm; margin-bottom: 2mm;" /><br>
      <strong style="font-size: 11pt;">JNK Express Padala</strong><br><br>
      <strong>${name}</strong><br>
      Brgy: ${barangay}<br>
      Price: ‚Ç±${price}<br>
      Tracking #: ${number}<br>
      <small>${new Date().toLocaleString()}</small><br><br>
      <em>Salamat sa tiwala KA-JNK!!</em>
    </div>`;

  const printWin = window.open('', '_blank', 'width=200,height=200');
  printWin.document.write(`
    <html>
      <head>
        <title>Print</title>
       <style>
  @page {
    size: 50mm 80mm portrait;
    margin: 0;
  }
  body {
    margin: 0;
    width: 50mm;
    height: 80mm;
  }
</style>
      </head>
      <body onload="window.print(); window.close();">${content}</body>
    </html>`);
  printWin.document.close();

  // Clear fields
  ["trackNumber", "parcelName", "barangay", "price", "trackStatus", "trackLocation", "estimatedDate"]
    .forEach(id => document.getElementById(id).value = "");

  loadAllEntries();
}

function loadAllEntries() {
  db.collection("tracking").orderBy("timestamp", "desc").onSnapshot(snapshot => {
    allEntries = snapshot.docs.map(doc => {
      const data = doc.data();
      return {
        id: doc.id,
        location: data.location || '-',
        statusHistory: data.statusHistory || [],
        estimatedDate: data.estimatedDate || '-',
        timestamp: data.timestamp?.toDate() || null,
      };
    });
    renderEntries();
  });
}

function renderEntries() {
  const search = document.getElementById("searchInput").value.toUpperCase();
  const entriesDiv = document.getElementById("entries");
  entriesDiv.innerHTML = "";
  const filtered = allEntries.filter(e => e.id.includes(search));
  const start = (currentPage - 1) * pageSize;
  const paginated = filtered.slice(start, start + pageSize);
  paginated.forEach(entry => {
    const timeline = entry.statusHistory.map(h => {
      const date = h.timestamp?.toDate().toLocaleString() || 'N/A';
      return `- [${date}] ${h.status}`;
    }).join("<br>");
    entriesDiv.innerHTML += `
      <div class='item'>
        <div class='item-content'>
          <strong>${entry.id}</strong><br>
          Location: ${entry.location}<br>
          Estimated Delivery: ${entry.estimatedDate}<br>
          <strong>Encoded:</strong> ${entry.timestamp ? entry.timestamp.toLocaleString() : 'N/A'}<br>
          Timeline:<div class='timeline'>${timeline}</div>
        </div>
        <button class='delete-btn' onclick="deleteEntry('${entry.id}')">Delete</button>
      </div>`;
  });
}

function nextPage() {
  const filtered = allEntries.filter(e => e.id.includes(document.getElementById("searchInput").value.toUpperCase()));
  const totalPages = Math.ceil(filtered.length / pageSize);
  if (currentPage < totalPages) currentPage++;
  renderEntries();
}

function prevPage() {
  if (currentPage > 1) currentPage--;
  renderEntries();
}

function exportCSVByDateRange() {
  const from = new Date(document.getElementById("exportFrom").value);
  const to = new Date(document.getElementById("exportTo").value);
  to.setHours(23, 59, 59, 999);
  const filtered = allEntries.filter(entry => entry.timestamp >= from && entry.timestamp <= to);
  if (filtered.length === 0) return alert("No entries found in selected date range.");
  const data = filtered.map(e => {
    const status = e.statusHistory.map(s => `${s.timestamp?.toDate().toLocaleString()} - ${s.status}`).join(" | ");
    return {
      TrackingNumber: e.id,
      Location: e.location,
      EstimatedDelivery: e.estimatedDate,
      StatusTimeline: status
    };
  });
  const csv = Papa.unparse(data);
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = `tracking_export_${filtered.length}_items_${Date.now()}.csv`;
  link.click();
}

async function deleteEntry(id) {
  const confirmPass = prompt("Enter admin password to delete:");
  if (confirmPass !== PASSWORD) return alert("‚ùå Incorrect password.");
  await db.collection("tracking").doc(id).delete();
  alert("Deleted.");
  loadAllEntries();
}

/* ---------- ORIGINAL bulkUpdateByTimeRange (kept) ---------- */
async function bulkUpdateByTimeRange() {
  const date = document.getElementById("bulkDate").value;
  const start = document.getElementById("startTime").value;
  const end = document.getElementById("endTime").value;
  const status = document.getElementById("bulkStatus").value;
  const location = document.getElementById("bulkLocation").value.trim();
  if (!date || !start || !end || !status) return alert("Fill all fields.");
  const confirmPass = prompt("Enter admin password to apply bulk update:");
  if (confirmPass !== PASSWORD) return alert("‚ùå Incorrect password.");

  const fromDate = new Date(`${date}T${start}`);
  const toDate = new Date(`${date}T${end}`);

  // Prefer querying by range for performance
  const snapshot = await db.collection("tracking")
    .where("timestamp", ">=", firebase.firestore.Timestamp.fromDate(fromDate))
    .where("timestamp", "<=", firebase.firestore.Timestamp.fromDate(toDate))
    .get();

  const batch = db.batch();
  snapshot.docs.forEach(doc => {
    const data = doc.data();
    const history = data.statusHistory || [];
    history.push({ status, timestamp: firebase.firestore.Timestamp.now() });
    batch.update(doc.ref, {
      location: location || data.location,
      estimatedDate: data.estimatedDate || '',
      statusHistory: history
    });
  });
  await batch.commit();
  alert(`‚úÖ Bulk update applied to ${snapshot.size} items.`);
  loadAllEntries();
}

/* ---------- NEW FROM‚ÄìTO bulk update ---------- */
async function bulkUpdateByFromTo() {
  // New inputs
  const fromDateStr = document.getElementById("bulkFromDate").value;
  const fromTimeStr = document.getElementById("bulkFromTime").value;
  const toDateStr   = document.getElementById("bulkToDate").value;
  const toTimeStr   = document.getElementById("bulkToTime").value;

  const status = document.getElementById("bulkStatusNew").value || document.getElementById("bulkStatus").value;
  const location = (document.getElementById("bulkLocationNew").value || document.getElementById("bulkLocation").value).trim();

  // Fallback to original single-day inputs if new ones are incomplete
  let fromDateTime, toDateTime;
  if (fromDateStr && fromTimeStr && toDateStr && toTimeStr) {
    fromDateTime = new Date(`${fromDateStr}T${fromTimeStr}`);
    toDateTime   = new Date(`${toDateStr}T${toTimeStr}`);
  } else {
    const date = document.getElementById("bulkDate").value;
    const start = document.getElementById("startTime").value;
    const end = document.getElementById("endTime").value;
    if (!(date && start && end)) {
      return alert("Fill all FROM and TO date/time, or use the original single-day fields.");
    }
    fromDateTime = new Date(`${date}T${start}`);
    toDateTime   = new Date(`${date}T${end}`);
  }

  if (!status) return alert("Choose a status.");
  if (toDateTime < fromDateTime) return alert("TO must be after FROM.");

  const confirmPass = prompt("Enter admin password to apply bulk update:");
  if (confirmPass !== PASSWORD) return alert("‚ùå Incorrect password.");

  const fromTs = firebase.firestore.Timestamp.fromDate(fromDateTime);
  const toTs   = firebase.firestore.Timestamp.fromDate(toDateTime);

  // Range query
  const snapshot = await db.collection("tracking")
    .where("timestamp", ">=", fromTs)
    .where("timestamp", "<=", toTs)
    .get();

  const batch = db.batch();
  snapshot.docs.forEach(doc => {
    const data = doc.data();
    const history = data.statusHistory || [];
    history.push({ status, timestamp: firebase.firestore.Timestamp.now() });
    batch.update(doc.ref, {
      location: location || data.location,
      estimatedDate: data.estimatedDate || '',
      statusHistory: history
    });
  });

  await batch.commit();
  alert(`‚úÖ FROM‚ÄìTO bulk update applied to ${snapshot.size} items.`);
  loadAllEntries();
}
</script>
</body>
</html>
